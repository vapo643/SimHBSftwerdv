# MISSÃO FINAL: Implementar a API de Criação de Usuários (MVP)

**CONTEXTO:** O schema do nosso banco de dados no Supabase foi validado. A tabela `profiles` possui uma coluna `loja_id` que será usada para associar usuários com os perfis 'GERENTE' e 'ATENDENTE' a uma loja específica (relação 1:1). Nossa stack é Express, Zod e supabase-js. O escopo do MVP é para os perfis 'ADMINISTRADOR', 'GERENTE' e 'ATENDENTE'.

**AÇÃO:** Gere o código backend necessário para criar novos usuários, com uma clara separação entre a lógica de negócio (serviço) e o tratamento da requisição (rota).

**ETAPAS:**

**1. Lógica de Serviço (Ficheiro: `/server/services/userService.ts`):**
Crie e exporte uma função de serviço assíncrona chamada `createUser`.
- **Lógica:**
    a. Verifique se o email já existe em `auth.users` usando um método eficiente.
    b. Gere uma senha provisória criptograficamente segura.
    c. Use `supabase.auth.admin.createUser()` para criar o usuário no Supabase Auth.
    d. Insira os dados (`id` do Auth, `role`, `full_name`, `loja_id`) na nossa tabela `profiles`.
    e. **Implemente "rollback":** Se a inserção em `profiles` falhar, delete o usuário recém-criado do Auth.
    f. Chame uma função `sendWelcomeEmail` mockada que apenas loga a senha no console.
    g. Retorne o usuário criado (sem a senha).

**2. Endpoint da Rota (Ficheiro: `/server/routes.ts`):**
Crie o endpoint `POST /api/admin/users`.
- **Middleware:** Proteja a rota para que apenas 'ADMINISTRADORES' possam acessá-la.
- **Validação com Zod:** Crie um schema Zod que:
    a. Valide os campos `fullName`, `email`, e `role` (enum com 'ADMINISTRADOR', 'GERENTE', 'ATENDENTE').
    b. **Use `.refine()`** para adicionar uma regra condicional: se o `role` for 'GERENTE' ou 'ATENDENTE', o campo `loja_id` deve ser um número/inteiro válido e obrigatório.
- **Controlador da Rota:**
    a. Chame a função `createUser` do serviço dentro de um bloco `try...catch`.
    b. Retorne os status codes de erro apropriados (`400`, `409`, `500`) e `201 Created` para sucesso.

Por favor, forneça o código completo para o ficheiro `userService.ts` e o código a ser adicionado em `routes.ts`.