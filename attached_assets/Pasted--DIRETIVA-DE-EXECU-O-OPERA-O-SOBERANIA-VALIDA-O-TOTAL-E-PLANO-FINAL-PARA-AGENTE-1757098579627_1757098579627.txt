### **DIRETIVA DE EXECUÇÃO: OPERAÇÃO SOBERANIA - VALIDAÇÃO TOTAL E PLANO FINAL**
### **PARA: AGENTE EXECUTOR DE ELITE (AUDITOR SÊNIOR)**

**PROTOCOLO DE ATIVAÇÃO:** Você está a operar como um **Auditor de Garantia de Missão Crítica**. A "Operação Aço Líquido" foi concluída, mas a prontidão para produção ainda não foi certificada. A sua missão é executar a validação final e mais rigorosa do sistema Simpix.

**MANDATO DE EXECUÇÃO:** Adote uma postura de **CETICISMO SÊNIOR ABSOLUTO**. Não confie em nenhuma linha de código. Assuma que cada funcionalidade, integração e fluxo de dados está QUEBRADO até que você prove, de forma irrefutável, o contrário.

**OBJETIVO FINAL:** Com base na sua auditoria exaustiva, você gerará um plano de correção final e detalhado, o `PLANO_DE_SOBERANIA_FINAL.md`.

---

#### **1. METODOLOGIA: AUDITORIA ORIENTADA AO COMPORTAMENTO (BDA)**

Você executará uma **Auditoria Orientada ao Comportamento (Behavior-Driven Audit)**. Você seguirá a jornada completa do usuário, validando cada interação, transição de estado e integração de dados, da UI ao Banco de Dados.

**REQUISITOS DE EVIDÊNCIA (PROVA IRREFUTÁVEL):** Para cada passo, você deve fornecer:
*   **Comportamento da UI:** Descrição textual do estado observado.
*   **Chamadas de API:** Método HTTP, Endpoint, Payload Enviado e Resposta Recebida.
*   **Execução no Backend:** Use Cases executados, Métodos de Domínio chamados.
*   **Persistência:** Queries Drizzle/SQL executadas e o estado resultante no Banco de Dados (Confirmação do `SELECT` pós-operação).

---

#### **2. VALIDAÇÃO DA INTEGRIDADE ARQUITETURAL PÓS-REFORMA**

Antes de iniciar o fluxo E2E, valide se os pilares arquiteturais da Operação Aço Líquido (Roadmap) foram estabelecidos corretamente.

1.  **Unificação do Domínio (Anti-Crise de Identidade - Roadmap P1.1/P1.2):**
    *   **Verificar:** Existe apenas UM agregado `Proposal` (`server/modules/proposal/domain/Proposal.ts`) e UMA implementação de `ProposalRepository` (`server/modules/proposal/infrastructure/ProposalRepository.ts`) em todo o sistema?
2.  **Modelo de Domínio Rico (Anti-Vazamento - Roadmap P2.1):**
    *   **Verificar:** A lógica de negócio (validações, cálculos, transições de estado) reside EXCLUSIVAMENTE no domínio? Os Controllers e Repositories estão livres de regras de negócio?
3.  **Inversão de Dependência (Anti-Acoplamento - Roadmap P1.3):**
    *   **Verificar:** Todas as dependências nos Controllers e Use Cases são injetadas via interfaces? Não existe `new ConcreteClass()` fora das Factories/IoC Container?
4.  **Pipeline Unificado (Anti-Cisma de Dados - Roadmap P2.3):**
    *   **Verificar:** As rotas Legacy (`server/routes/propostas/core.ts`) foram completamente eliminadas? Todo o tráfego passa pelo pipeline DDD unificado?

---

#### **3. O CICLO DE VIDA DA PROPOSTA: ROTEIRO DE VALIDAÇÃO E2E**

Execute a validação seguindo rigorosamente estas etapas do "Caminho Dourado":

##### **ETAPA 1: CRIAÇÃO E SUBMISSÃO (Papel: Atendente)**

1.  **Validação do Formulário de Criação:**
    *   **Ação:** Acessar a tela de criação.
    *   **Verificar:** As validações de UI (campos obrigatórios, máscaras de CPF/Dinheiro, limites) estão a funcionar?
2.  **Criação da Proposta (Rascunho):**
    *   **Ação:** Preencher e salvar rascunho.
    *   **Verificar:** A proposta é criada como `RASCUNHO`? Todos os dados (Cliente, Condições, Loja, Parceiro) foram persistidos corretamente? O `CreateProposalUseCase` foi utilizado?
3.  **Upload de Documentos:**
    *   **Ação:** Fazer upload de documentos (CNH, Comprovante).
    *   **Verificar:** Os arquivos são armazenados no Supabase Storage? Os metadados são associados à proposta? É possível visualizar os documentos após o upload?
4.  **Submissão para Análise (Transição Crítica):**
    *   **Ação:** Clicar em "Enviar para Análise".
    *   **Verificar:** O `SubmitForAnalysisUseCase` é executado? O estado transita corretamente de `RASCUNHO` para `AGUARDANDO_ANALISE` (ou estado definido no Roadmap P2.2)? As validações de domínio pré-submissão são executadas?

##### **ETAPA 2: FILA E ANÁLISE (Papel: Analista de Crédito)**

5.  **Validação da Fila de Análise:**
    *   **Ação:** Acessar a Fila de Análise (`/credito/fila`).
    *   **Verificar:** A proposta submetida aparece na fila? Todos os dados críticos estão espelhados corretamente (Data Mirroring)? Os filtros e a paginação funcionam e são performáticos (Sem N+1)?
6.  **Início da Análise:**
    *   **Ação:** Clicar na proposta.
    *   **Verificar:** O estado transita para `EM_ANALISE`? A tela de detalhes carrega 100% dos dados e documentos associados?
7.  **Execução das Ações de Análise (Aprovar/Negar/Pendenciar):**
    *   **Ação (Cenário A - Aprovar):** Clicar em "Aprovar".
    *   **Verificar:** O `ApproveProposalUseCase` é executado? O estado transita para `APROVADO`? A proposta sai da fila ativa?
    *   *(Repetir validação rigorosa para Cenário B - Negar e Cenário C - Pendenciar).*

##### **ETAPA 3: FORMALIZAÇÃO E GERAÇÃO DE CCB (Papel: Backoffice)**

8.  **Geração da Cédula de Crédito Bancário (CCB):**
    *   **Ação:** Na proposta aprovada, gerar a CCB.
    *   **Verificar:** O PDF é gerado corretamente com todos os dados da proposta (Valores, Taxas, Prazos)? O PDF é armazenado no Supabase Storage?

##### **ETAPA 4: INTEGRAÇÕES EXTERNAS (ClickSign e Banco Inter)**

9.  **Integração ClickSign (Envio):**
    *   **Ação:** Enviar a CCB para assinatura.
    *   **Verificar:** A API da ClickSign é chamada corretamente? O documento é enviado? O estado da proposta atualiza (ex: `AGUARDANDO_ASSINATURA`)?
10. **Integração ClickSign (Webhook e Armazenamento):**
    *   **Ação:** Simular a receção do webhook de assinatura concluída.
    *   **Verificar:** O endpoint do webhook funciona? O sistema processa a confirmação? **CRÍTICO:** O documento assinado é automaticamente baixado e armazenado de forma segura no Storage? O estado da proposta atualiza para `ASSINADO` (ou equivalente)?
11. **Integração Banco Inter (Geração de Boleto):**
    *   **Ação:** Gerar boleto para a proposta assinada.
    *   **Verificar:** A API do Banco Inter é chamada corretamente? O boleto é gerado com valores/datas corretos? O PDF do boleto é armazenado e disponibilizado para download?

##### **ETAPA 5: PÓS-FORMALIZAÇÃO (COBRANÇAS E PAGAMENTOS)**

12. **Visibilidade na Área Financeira:**
    *   **Ação:** Acessar a área de "Pagamentos e Cobranças".
    *   **Verificar:** A proposta formalizada aparece corretamente listada? Os detalhes do boleto e contrato estão corretos e consistentes?

---

#### **4. SÍNTESE E GERAÇÃO DO PLANO FINAL**

Após completar as validações das Seções 2 e 3, compile todas as suas descobertas e gere o `PLANO_DE_SOBERANIA_FINAL.md`.

**Estrutura Obrigatória do `PLANO_DE_SOBERANIA_FINAL.md`:**

```markdown
# PLANO DE SOBERANIA FINAL - CERTIFICAÇÃO PÓS-"AÇO LÍQUIDO"

**Data:** 2025-09-05
**Veredito Executivo:** [Ex: PRONTO PARA PRODUÇÃO COM RESSALVAS / FALHA NA VALIDAÇÃO]
**Nível de Confiança:** [Ex: 98%]

---

## 1. RESULTADOS DA VALIDAÇÃO ARQUITETURAL (SEÇÃO 2)

| ID | Checkpoint | Status (✅/❌) | Resumo da Descoberta e Evidência |
| :--| :--- | :---: | :--- |
| A1 | Unificação do Domínio | [Status] | [Resumo e Snippet de Prova] |
| A2 | Modelo de Domínio Rico| [Status] | [Resumo e Snippet de Prova] |
| A3 | Inversão de Dependência| [Status] | [Resumo e Snippet de Prova] |
| A4 | Pipeline Unificado | [Status] | [Resumo e Snippet de Prova] |

---

## 2. RESULTADOS DA AUDITORIA COMPORTAMENTAL E2E (SEÇÃO 3)

[Tabela resumindo o status de cada checkpoint do fluxo de negócio.]

| ID | Etapa | Checkpoint | Status (✅/⚠️/❌) | Resumo da Descoberta e Evidência |
|:--| :--- | :--- | :---: | :--- |
| E1.1| Criação | Validação Formulário | [Status] | [Resumo e Prova (API/Código/DB)] |
| E1.2| Criação | Criação Rascunho (DB) | [Status] | [Resumo e Prova] |
| E1.3| Criação | Upload Documentos | [Status] | [Resumo e Prova] |
| E1.4| Criação | Submissão Análise (FSM) | [Status] | [Resumo e Prova] |
| E2.5| Análise | Fila de Análise (Visibilidade/Dados) | [Status] | [Resumo e Prova] |
| E2.6| Análise | Início da Análise (FSM/Dados) | [Status] | [Resumo e Prova] |
| E2.7| Análise | Ações (Aprovar/Negar/Pendenciar) | [Status] | [Resumo e Prova] |
| E3.8| Formalização| Geração CCB (PDF/Storage) | [Status] | [Resumo e Prova] |
| E4.9| Integrações| ClickSign (Envio/FSM) | [Status] | [Resumo e Prova] |
| E4.10| Integrações| ClickSign (Webhook/Storage) | [Status] | [Resumo e Prova] |
| E4.11| Integrações| Banco Inter (Boleto/Storage) | [Status] | [Resumo e Prova] |
| E5.12| Cobranças | Visibilidade Financeira | [Status] | [Resumo e Prova] |

---

## 3. PUNCH LIST FINAL E PLANO DE CORREÇÃO DEFINITIVO

[Para cada item com status ⚠️ ou ❌ nas tabelas acima, detalhe o plano de ação técnico exato. Organize por prioridade (P0 = Impeditivo de Produção).]

### P0 - CORREÇÕES CRÍTICAS

#### Ação P0.1: Corrigir [Falha ID - Ex: E4.10 Webhook ClickSign]
*   **Causa Raiz (Identificada na Auditoria):** [Ex: Use Case não está a baixar o PDF assinado]
*   **Plano de Execução Detalhado:**
    1. [Ação técnica 1] em [Arquivo/Módulo]
    2. [Ação técnica 2] em [Arquivo/Módulo]
    3. [Critérios de Validação pós-correção]

### P1 - CORREÇÕES IMPORTANTES

#### Ação P1.1: Corrigir [Falha ID]
*   ...

### P2 - AJUSTES MENORES E OTIMIZAÇÕES

#### Ação P2.1: Corrigir [Falha ID]
*   ...

---

## 4. CONCLUSÃO E RECOMENDAÇÃO DE PRODUÇÃO

[Recomendação final sobre a implantação em produção. Se houver ações P0, a recomendação DEVE ser NÃO IMPLANTAR até a correção e re-validação.]