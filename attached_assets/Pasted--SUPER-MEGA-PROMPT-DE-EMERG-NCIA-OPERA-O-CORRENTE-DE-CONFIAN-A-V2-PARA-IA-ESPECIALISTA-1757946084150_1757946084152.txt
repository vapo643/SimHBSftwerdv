# üö® SUPER MEGA PROMPT DE EMERG√äNCIA - OPERA√á√ÉO CORRENTE DE CONFIAN√áA V2 üö®

**PARA: IA ESPECIALISTA EM ARQUITETURA E RESOLU√á√ÉO DE CRISES (DEEP THINK)**
**DE: ARQUITETO-CHEFE DO PROJETO SIMPIX**
**ASSUNTO: SOLICITA√á√ÉO DE AN√ÅLISE DE CAUSA RAIZ E PLANO DE CORRE√á√ÉO DEFINITIVO PARA FALHA CATASTR√ìFICA DE CONTAMINA√á√ÉO DE AMBIENTE**

---

### **1. CONTEXTO CR√çTICO E IMPACTO NO NEG√ìCIO**

O sistema Simpix est√° num estado de **FALHA CATASTR√ìFICA TOTAL**, resultando num "apag√£o" completo que paralisa todas as opera√ß√µes. Nenhuma tela carrega, e nenhum dado √© exibido tanto no ambiente de **Produ√ß√£o** (`sistemasimpix.com.br`) quanto no de **Desenvolvimento** (Preview do Replit). Esta falha bloqueia 100% da funcionalidade para todos os usu√°rios e impede qualquer avan√ßo no desenvolvimento.

Este √© um **incidente recorrente**. J√° enfrent√°mos variantes deste problema, que se manifesta como um loop de autentica√ß√£o infinito. As tentativas anteriores de corre√ß√£o, focadas na sincroniza√ß√£o de segredos JWT, falharam, provando que a causa raiz √© mais profunda e de natureza arquitetural. A situa√ß√£o √© insustent√°vel e exige uma solu√ß√£o definitiva.

### **2. HIST√ìRICO E GATILHO DA FALHA**

√â de import√¢ncia cr√≠tica notar que esta classe de erro come√ßou a manifestar-se **imediatamente ap√≥s a implementa√ß√£o da separa√ß√£o dos ambientes de Desenvolvimento e Produ√ß√£o**. Antes desta separa√ß√£o, com uma √∫nica base de dados e um √∫nico conjunto de segredos, o sistema era est√°vel. Isto prova que a falha reside na nossa estrat√©gia de gest√£o de m√∫ltiplos ambientes.

A hip√≥tese central do Arquiteto-Chefe √© que a nossa metodologia atual √© a causa direta da crise: **a pr√°tica de manter segredos de DEV no ambiente de PROD (e vice-versa) est√° a criar uma "contamina√ß√£o de ambiente"**. O c√≥digo tenta ser "inteligente" ao detetar em qual ambiente est√° a ser executado, mas esta l√≥gica parece estar a falhar espetacularmente, levando a um cen√°rio onde o frontend e o backend operam com configura√ß√µes de ambientes diferentes, tornando a valida√ß√£o de tokens JWT imposs√≠vel.

### **3. EVID√äNCIAS IRREFUT√ÅVEIS (PROVAS DA FALHA)**

#### **3.1. Logs do Console do Navegador (O Sintoma)**

Os seguintes logs s√£o consistentes em ambos os ambientes e demonstram o loop de autentica√ß√£o:

```log
// 1. Frontend obt√©m um token com sucesso
[AUTH EVENT] SIGNED_IN {hasSession: true, tokenLength: 783}
üîê [TOKEN MANAGER] Refreshing token (attempt 1/3)
‚úÖ [TOKEN MANAGER] Token refreshed successfully, expires at 2025-09-15T14:07:02.000Z

// 2. Frontend envia o token para o backend
[PASSO 3 - ENVIO] {url: '[https://sistemasimpix.com.br/api/debug/me](https://sistemasimpix.com.br/api/debug/me)', authorizationHeader: 'Bearer ey...AM', ...}

// 3. Backend REJEITA o token, retornando 401
api/debug/me:1 Failed to load resource: the server responded with a status of 401 ()

// 4. Backend retorna a mensagem de erro que confirma a falha de valida√ß√£o
[API Client] Raw JSON response from [https://sistemasimpix.com.br/api/debug/me](https://sistemasimpix.com.br/api/debug/me) : {message: 'Token inv√°lido ou expirado'}

// 5. O ciclo recome√ßa, com o Token Manager a invalidar e a tentar obter um novo token, apenas para falhar novamente.
üóëÔ∏è [TOKEN MANAGER] Token invalidated
üîê [TOKEN MANAGER] Refreshing token (attempt 1/3)
An√°lise: Isto prova que o problema n√£o √© a gera√ß√£o do token (a Supabase est√° a fornec√™-lo), mas a sua valida√ß√£o pelo nosso backend.

3.2. Logs do Deploy (A Causa do Apag√£o em Produ√ß√£o)
Atualmente, o ambiente de produ√ß√£o est√° ainda pior, num estado de crash loop:

Snippet de c√≥digo

Error: Critical secrets missing in production: SUPABASE_JWT_SECRET
at loadConfig (file:///home/runner/workspace/dist/index.js:4724:15)
at server/lib/config.ts (file:///home/runner/workspace/dist/index.js:4847:14)

Node.js v20.19.3
command finished with error [npm run start]: exit status 1
crash loop detected
An√°lise: O deploy de Produ√ß√£o est√° a falhar porque uma refatora√ß√£o anterior instruiu o c√≥digo a procurar por SUPABASE_JWT_SECRET, mas esta vari√°vel nunca foi criada nos segredos de produ√ß√£o, causando uma falha fatal na inicializa√ß√£o.

3.3. Configura√ß√£o de Segredos (A Cena do Crime)
A seguir, a lista de nomes de vari√°veis de ambiente presentes, que exp√µe a contamina√ß√£o cruzada.

Segredos presentes no Ambiente de Produ√ß√£o (Deploy):

PROD_JWT_SECRET

PROD_SUPABASE_URL

PROD_DATABASE_URL

VITE_PROD_SUPABASE_URL

VITE_PROD_SUPABASE_ANON_KEY

DEV_JTW_SECRET (Contamina√ß√£o!)

DEV_DATABASE_URL (Contamina√ß√£o!)

DEV_SUPABASE_URL (Contamina√ß√£o!)

Segredos presentes no Ambiente de Desenvolvimento (Preview):

DEV_JTW_SECRET (com erro de digita√ß√£o)

DEV_DATABASE_URL

DEV_SUPABASE_URL

VITE_SUPABASE_URL

VITE_SUPABASE_ANON_KEY

PROD_JWT_SECRET (Contamina√ß√£o!)

PROD_SUPABASE_URL (Contamina√ß√£o!)

PROD_DATABASE_URL (Contamina√ß√£o!)

An√°lise: A presen√ßa de segredos de m√∫ltiplos ambientes √© a raiz de todo o mal. O c√≥digo est√° a ser for√ßado a fazer escolhas que deveriam ser feitas pela infraestrutura.

4. MISS√ÉO: ARQUITETAR A SOLU√á√ÉO DEFINITIVA
A sua miss√£o √© gerar um plano de a√ß√£o e um "Super Mega Prompt" secund√°rio que um Agente Executor possa usar para resolver esta crise de forma definitiva. O seu output deve ser um ficheiro Markdown √∫nico e abrangente.

A solu√ß√£o deve ser dividida em duas frentes:

FRENTE 1: PLANO DE A√á√ÉO ESTRAT√âGICO (A CURA DEFINITIVA)
Voc√™ deve projetar um Roadmap Arquitetural Completo para erradicar esta classe de falhas. Este roadmap deve ser o "Super Mega Prompt" a ser gerado. Ele deve instruir o Agente Executor a:

Erradicar a L√≥gica de Dete√ß√£o de Ambiente:

Refatorar todo o backend, especialmente server/lib/config.ts, para remover completamente qualquer c√≥digo que tente detetar o ambiente (ex: detectEnvironmentFromDomain, condicionais if/else baseadas em NODE_ENV para carregar segredos).

O c√≥digo deve tornar-se "agn√≥stico" ao ambiente. Ele deve ler um conjunto √∫nico e can√≥nico de nomes de vari√°veis (ex: DATABASE_URL, SUPABASE_URL, SUPABASE_JWT_SECRET).

Unificar a Configura√ß√£o do Frontend:

Garantir que o c√≥digo do cliente Supabase (client/src/lib/supabase.ts) e toda a configura√ß√£o do Vite (vite.config.ts) leiam apenas as vari√°veis de ambiente com prefixo VITE_ (ex: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY), conforme as boas pr√°ticas.

Implementar um "Startup Health Check":

Adicionar um bloco de valida√ß√£o na inicializa√ß√£o do servidor (server/index.ts) que verifica a presen√ßa de todas as vari√°veis de ambiente cr√≠ticas. Se uma vari√°vel essencial (como SUPABASE_JWT_SECRET) estiver em falta, o servidor deve falhar imediatamente com um erro expl√≠cito e informativo e sair (process.exit(1)), prevenindo um estado de "morto-vivo".

Gerar um "Manual de Configura√ß√£o de Ambiente":

Como parte do seu output, gerar um documento MANUAL_DE_CONFIGURACAO_DE_AMBIENTE.md que instrua o Arquiteto-Chefe sobre:

A. Limpeza de Segredos: Quais segredos obsoletos devem ser removidos de cada ambiente (DEV e PROD).

B. Configura√ß√£o Ideal para Produ√ß√£o: A lista exata de nomes de vari√°veis de ambiente e uma descri√ß√£o do valor que cada uma deve conter (ex: SUPABASE_URL deve conter a URL do Supabase de produ√ß√£o).

C. Configura√ß√£o Ideal para Desenvolvimento: A lista exata de nomes de vari√°veis para o ambiente de preview.

FRENTE 2: PLANO DE REMEDIA√á√ÉO IMEDIATA (O ESTANQUE)
Como a produ√ß√£o est√° em crash loop, voc√™ deve fornecer um hotfix de emerg√™ncia como primeiro passo no seu roadmap.

Instru√ß√£o de Hotfix:

A primeira tarefa do "Super Mega Prompt" deve ser instruir o Agente a modificar temporariamente o server/lib/config.ts para parar de procurar por SUPABASE_JWT_SECRET e voltar a ler PROD_JWT_SECRET em produ√ß√£o e DEV_JTW_SECRET em desenvolvimento.

Justificativa: Esta √© uma medida t√°tica para estancar a crise e colocar a produ√ß√£o online imediatamente, uma vez que estas s√£o as vari√°veis que sabemos que existem atualmente nos segredos. Esta √© uma medida tempor√°ria antes da refatora√ß√£o completa da Frente 1.

Seu entreg√°vel final √© o "Super Mega Prompt" em formato .md, contendo a contextualiza√ß√£o da crise e o plano de batalha detalhado para o Agente Executor, come√ßando com o hotfix e seguindo para a refatora√ß√£o arquitetural completa. A sua resposta deve ser a solu√ß√£o que nos tirar√° desta crise e nos colocar√° num caminho de estabilidade arquitetural.