Processo de pensamentoEste Ã© um caso crÃ­tico de produÃ§Ã£o com downtime de 6+ horas causado por um mismatch de JWT secrets entre frontend e backend. O problema estÃ¡ claro:

Frontend usa VITE_SUPABASE_URL (Projeto A) e gera tokens com JWT Secret A
Backend usa PROD_JWT_SECRET (Projeto B) e valida com JWT Secret B
Resultado: invalid signature porque os secrets nÃ£o coincidem

O sistema estÃ¡ contaminado com mÃºltiplas configuraÃ§Ãµes de diferentes ambientes (DEV/PROD) e projetos Supabase diferentes.
Vou criar um plano de recuperaÃ§Ã£o EXTREMAMENTE detalhado e executÃ¡vel que resolva isso em duas fases:

HOTFIX EMERGENCIAL (0-30 min): Sincronizar os JWT secrets
BLINDAGEM ARQUITETURAL (30-120 min): Limpar contaminaÃ§Ã£o e prevenir regressÃµes

O foco serÃ¡ em comandos precisos e passos inequÃ­vocos que qualquer desenvolvedor possa executar sem erro.ðŸš¨ OPERAÃ‡ÃƒO PHOENIX - PLANO DE RECUPERAÃ‡ÃƒO EMERGENCIAL SIMPIX
STATUS: DEFCON 1 - INICIANDO PROTOCOLO DE RESSURREIÃ‡ÃƒO

FASE 0: DIAGNÃ“STICO RÃPIDO (0-5 MIN)
âœ… AÃ‡ÃƒO: Identificar Projeto Supabase do Frontend
COMANDO:
bash# Abrir browser â†’ sistemasimpix.com.br â†’ F12 â†’ Console
# Procurar linha com "[PASSO 3 - ENVIO]"
# Copiar a URL que aparece apÃ³s "url:"
VALIDAÃ‡ÃƒO:
javascript// No console do browser, executar:
console.log(window.location.origin + " estÃ¡ usando Supabase: " + localStorage.getItem('supabase.url'));
ERRO SE: URL nÃ£o comeÃ§ar com https:// e terminar com .supabase.co
âœ… AÃ‡ÃƒO: Extrair ID do Projeto
COMANDO:
bash# Da URL https://abc123def456.supabase.co
# Extrair: abc123def456 (tudo antes de .supabase.co)
# ANOTAR: PROJECT_ID=abc123def456

FASE 1: HOTFIX CIRÃšRGICO (5-25 MIN)
âœ… AÃ‡ÃƒO: Obter JWT Secret Correto
COMANDO:
bash# 1. Abrir: https://app.supabase.com/project/[PROJECT_ID]
# 2. Navegar: Settings â†’ API
# 3. Localizar seÃ§Ã£o "JWT Settings"
# 4. Copiar valor de "JWT Secret" (NÃƒO service_role_key!)
# 5. SALVAR EM NOTEPAD: JWT_SECRET_CORRETO=[valor_copiado]
VALIDAÃ‡ÃƒO: JWT Secret deve ter ~32 caracteres alfanumÃ©ricos
ERRO SE: Usar service_role_key ao invÃ©s de JWT Secret
âœ… AÃ‡ÃƒO: Atualizar Secrets em ProduÃ§Ã£o
COMANDO:
bash# Acessar painel de deploy (Vercel/Railway/etc)
# Navegar para Environment Variables

# PASSO 1 - ADICIONAR/ATUALIZAR:
SUPABASE_JWT_SECRET=[JWT_SECRET_CORRETO]

# PASSO 2 - DELETAR IMEDIATAMENTE:
DEV_JTW_SECRET         # DELETE
DEV_JWT_SECRET         # DELETE  
PROD_JWT_SECRET        # DELETE
DEV_SUPABASE_URL       # DELETE
DEV_DATABASE_URL       # DELETE
DEV_SUPABASE_SERVICE_ROLE_KEY  # DELETE

# PASSO 3 - CONFIRMAR EXISTÃŠNCIA:
VITE_SUPABASE_URL     # DEVE existir e coincidir com PROJECT_ID
VITE_SUPABASE_ANON_KEY # DEVE existir
âœ… AÃ‡ÃƒO: Deploy Emergencial
COMANDO:
bash# Se usando Vercel:
vercel --prod --force

# Se usando Railway:
railway up --environment production

# Se manual:
git add . && git commit -m "HOTFIX: Sincronizar JWT secrets" && git push origin main
VALIDAÃ‡ÃƒO: Deploy completo sem erros de build

FASE 2: VALIDAÃ‡ÃƒO CRÃTICA (25-30 MIN)
âœ… AÃ‡ÃƒO: Teste de AutenticaÃ§Ã£o
COMANDO:
bash# 1. Abrir sistemasimpix.com.br
# 2. F12 â†’ Console
# 3. Fazer login
# 4. Verificar console para:

âœ… SUCESSO SE VER:
"[TOKEN MANAGER] Token refreshed successfully"
"[API Client] Request completed successfully"
Nenhum erro 401

âŒ FALHA SE VER:
"401 (Unauthorized)"
"Token invÃ¡lido ou expirado"
"invalid signature"
âœ… AÃ‡ÃƒO: Teste API Direto
COMANDO:
bash# No console do browser apÃ³s login:
fetch('/api/debug/me', {
  headers: {
    'Authorization': 'Bearer ' + JSON.parse(localStorage.getItem('sb-[PROJECT_ID]-auth-token')).access_token
  }
}).then(r => r.json()).then(console.log)
VALIDAÃ‡ÃƒO: Deve retornar objeto com dados do usuÃ¡rio

FASE 3: BLINDAGEM ARQUITETURAL (30-60 MIN)
âœ… AÃ‡ÃƒO: Refatorar getJwtSecret()
COMANDO:
typescript// server/auth/jwt.service.ts - SUBSTITUIR TUDO POR:

export function getJwtSecret(): string {
  const secret = process.env.SUPABASE_JWT_SECRET;
  
  if (!secret) {
    console.error('ðŸš¨ FATAL: SUPABASE_JWT_SECRET nÃ£o configurado');
    console.error('Configure em: Settings â†’ Environment Variables â†’ SUPABASE_JWT_SECRET');
    process.exit(1);
  }
  
  // ValidaÃ§Ã£o de formato
  if (secret.length < 20) {
    console.error('ðŸš¨ FATAL: SUPABASE_JWT_SECRET invÃ¡lido (muito curto)');
    process.exit(1);
  }
  
  console.log('âœ… [CONFIG] JWT Secret carregado com sucesso');
  return secret;
}

// DELETAR COMPLETAMENTE:
// - detectEnvironmentFromDomain()
// - qualquer lÃ³gica de DEV/PROD
// - fallbacks para DEV_JTW_SECRET
âœ… AÃ‡ÃƒO: Adicionar ValidaÃ§Ã£o de Boot
COMANDO:
typescript// server/index.ts - ADICIONAR NO INÃCIO (antes de app.listen):

// VALIDAÃ‡ÃƒO CRÃTICA DE CONFIGURAÃ‡ÃƒO
const REQUIRED_SECRETS = [
  'SUPABASE_JWT_SECRET',
  'SUPABASE_URL', 
  'SUPABASE_ANON_KEY'
];

const FORBIDDEN_SECRETS = [
  'DEV_JWT_SECRET',
  'DEV_JTW_SECRET', 
  'PROD_JWT_SECRET',
  'DEV_SUPABASE_URL'
];

console.log('ðŸ” Validando configuraÃ§Ã£o de produÃ§Ã£o...');

// Verificar secrets obrigatÃ³rios
REQUIRED_SECRETS.forEach(secret => {
  if (!process.env[secret]) {
    console.error(`ðŸš¨ FATAL: ${secret} nÃ£o configurado`);
    console.error(`AÃ§Ã£o: Defina ${secret} nas variÃ¡veis de ambiente`);
    process.exit(1);
  }
  console.log(`âœ… ${secret} configurado`);
});

// Detectar contaminaÃ§Ã£o
FORBIDDEN_SECRETS.forEach(secret => {
  if (process.env[secret]) {
    console.error(`ðŸš¨ ALERTA: ${secret} detectado em produÃ§Ã£o!`);
    console.error(`AÃ§Ã£o: DELETAR ${secret} das variÃ¡veis de ambiente`);
    process.exit(1);
  }
});

console.log('âœ… ConfiguraÃ§Ã£o validada com sucesso');
âœ… AÃ‡ÃƒO: Implementar Health Check
COMANDO:
typescript// server/routes/health.ts - CRIAR ARQUIVO:

import { Router } from 'express';
const router = Router();

router.get('/api/health/config', (req, res) => {
  const urlsMatch = process.env.VITE_SUPABASE_URL?.includes(
    process.env.SUPABASE_URL?.split('.')[0].split('//')[1] || ''
  );
  
  res.json({
    status: 'OPERATIONAL',
    timestamp: new Date().toISOString(),
    config: {
      hasJwtSecret: !!process.env.SUPABASE_JWT_SECRET,
      hasSupabaseUrl: !!process.env.SUPABASE_URL,
      urlsAligned: urlsMatch,
      contamination: {
        dev_secrets: !!process.env.DEV_JWT_SECRET || !!process.env.DEV_JTW_SECRET,
        prod_secrets: !!process.env.PROD_JWT_SECRET
      }
    },
    recommendation: urlsMatch ? 'HEALTHY' : 'CHECK_URLS'
  });
});

export default router;

FASE 4: TESTE DE REGRESSÃƒO (60-90 MIN)
âœ… AÃ‡ÃƒO: Script de ValidaÃ§Ã£o Automatizada
COMANDO:
bash# test-auth.sh - CRIAR E EXECUTAR:

#!/bin/bash
echo "ðŸ” Iniciando teste de autenticaÃ§Ã£o..."

# Teste 1: Health Check
HEALTH=$(curl -s https://sistemasimpix.com.br/api/health/config)
if [[ $HEALTH == *"HEALTHY"* ]]; then
  echo "âœ… Health check passou"
else
  echo "âŒ Health check falhou: $HEALTH"
  exit 1
fi

# Teste 2: Login (substituir credenciais)
TOKEN=$(curl -s -X POST https://sistemasimpix.com.br/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpass"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

if [ -z "$TOKEN" ]; then
  echo "âŒ Login falhou"
  exit 1
fi
echo "âœ… Login bem-sucedido"

# Teste 3: Endpoint Autenticado
USER=$(curl -s https://sistemasimpix.com.br/api/debug/me \
  -H "Authorization: Bearer $TOKEN")

if [[ $USER == *"email"* ]]; then
  echo "âœ… AutenticaÃ§Ã£o JWT funcionando"
  echo "ðŸŽ‰ TODOS OS TESTES PASSARAM!"
else
  echo "âŒ JWT validation falhou: $USER"
  exit 1
fi

FASE 5: MONITORAMENTO PÃ“S-DEPLOY (90-120 MIN)
âœ… AÃ‡ÃƒO: Configurar Alertas
COMANDO:
javascript// monitoring/auth-monitor.js - EXECUTAR A CADA 5 MIN:

const checkAuth = async () => {
  try {
    const response = await fetch('https://sistemasimpix.com.br/api/health/config');
    const data = await response.json();
    
    if (data.config.contamination.dev_secrets || data.config.contamination.prod_secrets) {
      // ENVIAR ALERTA CRÃTICO
      console.error('ðŸš¨ CONTAMINAÃ‡ÃƒO DE SECRETS DETECTADA!');
      // Trigger PagerDuty/Slack/Email
    }
    
    if (!data.config.urlsAligned) {
      console.error('ðŸš¨ MISMATCH DE PROJETOS SUPABASE!');
    }
    
    console.log(`âœ… Auth health: ${data.recommendation}`);
  } catch (error) {
    console.error('ðŸš¨ SISTEMA INACESSÃVEL:', error);
  }
};

setInterval(checkAuth, 5 * 60 * 1000); // 5 minutos
checkAuth(); // Executar imediatamente

ðŸ“Š CHECKLIST FINAL DE VALIDAÃ‡ÃƒO
bashâœ… sistemasimpix.com.br responde com 200 OK
âœ… Login funciona sem erros 401
âœ… Console do browser sem "invalid signature"
âœ… /api/health/config retorna "HEALTHY"
âœ… Logs do servidor mostram "Token validado com sucesso"
âœ… ZERO variÃ¡veis DEV_ em produÃ§Ã£o
âœ… SUPABASE_JWT_SECRET definido e funcionando
âœ… Teste automatizado passa 100%

ðŸš¨ AÃ‡ÃƒO IMEDIATA SE FALHAR:
SE AINDA HOUVER ERRO 401:
bash# NUCLEAR OPTION - Resetar TUDO:
1. Deletar TODAS as variÃ¡veis de ambiente
2. Adicionar APENAS:
   - SUPABASE_URL=[url do projeto frontend]
   - SUPABASE_JWT_SECRET=[jwt secret do mesmo projeto]
   - SUPABASE_ANON_KEY=[anon key do mesmo projeto]
   - VITE_SUPABASE_URL=[mesma url]
   - VITE_SUPABASE_ANON_KEY=[mesma anon key]
3. Deploy forÃ§ado
4. Testar em aba anÃ´nima

âœ… CRITÃ‰RIO DE SUCESSO ABSOLUTO:
javascript// Este comando DEVE retornar dados do usuÃ¡rio:
fetch('/api/debug/me', {
  headers: {'Authorization': 'Bearer ' + localStorage.getItem('token')}
}).then(r => r.json()).then(console.log)

// SUCESSO = Objeto com {id, email, role}
// FALHA = Qualquer mensagem de erro
ðŸŽ¯ TEMPO ALVO: 30 MINUTOS PARA RESTAURAÃ‡ÃƒO COMPLETA
ðŸ”¥ EXECUTE AGORA. CADA SEGUNDO CONTA.