# MISSÃO DE AUDITORIA: Garantir a Integridade de Dados da Proposta de Ponta a Ponta

**Contexto:**
Olá, Agente. O nosso fluxo de negócio está a avançar, mas estamos a enfrentar uma falha crítica e silenciosa: os dados das propostas estão a ser perdidos durante a sua jornada pelo nosso sistema. Precisamos da sua ajuda para realizar uma auditoria completa e garantir que uma proposta mantenha 100% da sua informação, do início ao fim.

**Os Problemas (Sintomas):**

1.  **Na "Formalização", os Documentos Anexados Sumiram:** Quando um `ANALISTA` ou `ATENDENTE` abre uma proposta na tela de "Formalização", a seção de "Documentos da Proposta" está vazia. Os documentos que foram anexados na criação não aparecem, apenas a CCB gerada.
2.  **A Visualização da CCB está Bloqueada:** Ao clicar em "Visualizar CCB", o sistema exibe um erro de "Conteúdo bloqueado", o que sugere um problema de permissão no nosso Supabase Storage.
3.  **A Taxa de Juros Sumiu:** Na mesma tela, a "Taxa de Juros" aparece como "N/A", indicando que este dado crítico também se perdeu no caminho.

**Sua Missão (A Auditoria e Correção):**
A sua tarefa é atuar como um detetive de dados e seguir a jornada completa de uma proposta, desde a sua criação até à formalização, para encontrar e corrigir os pontos onde a informação está a ser perdida.

**Roadmap de Investigação:**

1.  **Audite a "Ponte" da Aprovação:** A nossa hipótese principal é que o problema está no "intermediário" — o momento em que o `ANALISTA` clica em "Aprovar". Investigue o nosso endpoint `PUT /api/propostas/:id/status`. Quando ele muda o status de uma proposta para `aprovado`, ele está a preservar e a "carregar" todos os dados existentes (incluindo as referências aos documentos e a taxa de juros) para a próxima fase? Ou está a criar um novo registo de status que deixa os outros dados para trás?

2.  **Audite a "Ponte" da Visualização:** Investigue o endpoint que alimenta a tela de "Formalização" (`GET /api/proprostas/formalizacao`). Ele está a fazer os `JOIN`s corretos no banco de dados para buscar não apenas a proposta, mas também todos os seus documentos associados da tabela `proposta_documentos`?

3.  **Audite a Geração de URL da CCB:** Investigue a lógica que gera a URL para a visualização da CCB. Como o nosso bucket de `documents` é privado, ela precisa de gerar uma **URL assinada e temporária** do Supabase para permitir o acesso. A falha está aqui?

**Resumo da Missão:**
Corrija o nosso fluxo para que, quando uma proposta for aprovada, o "pacote completo" de informações — todos os dados do formulário, a taxa de juros e TODOS os documentos anexados — chegue intacto à tela de "Formalização" e possa ser visualizado sem erros.