# MISSÃO DE EXECUÇÃO (ANTI-FRÁGIL): FASE 1 - ESTABILIZAÇÃO CRÍTICA

**CONTEXTO ESTRATÉGICO:**
Este prompt é o resultado final de um debate arquitetural profundo. Ele contém a execução da **FASE 1** do nosso plano de refatoração. O objetivo é transformar o nosso sistema de frágil para estável, eliminando 80% dos crashes atuais com correções de alto impacto.

**AÇÃO:**
Sua missão é executar um plano de 3 frentes para estabilizar a nossa base de código.

**REGRAS DE EXECUÇÃO ANTI-FALHA (MANDATÓRIAS):**
* **UM FICHEIRO POR VEZ:** Nunca modifique múltiplos ficheiros simultaneamente.
* **VALIDAÇÃO CONSTANTE:** Valide cada mudança antes de avançar para o próximo passo.

**ROADMAP DE EXECUÇÃO (Sequencial):**

---
**FRENTE 1: CORREÇÃO DA CAMADA DE STORAGE (BACKEND)**
* **Passo 1.1:** No ficheiro `/server/storage.ts`, implemente o método ausente `getLojas()`. Ele deve buscar e retornar todas as lojas ativas.
* **Passo 1.2:** No mesmo ficheiro, implemente um método robusto `getUsersWithDetails()`. A query deve usar `LEFT JOIN`s para conectar `profiles` com `lojas`, `parceiros` e `auth.users`, retornando todos os dados necessários para a interface.

---
**FRENTE 2: ISOLAMENTO DAS QUERIES DO FRONTEND**
* **Passo 2.1:** Crie o ficheiro `/client/src/hooks/queries/queryKeys.ts`. Implemente nele a "fábrica" de chaves de query hierárquicas e isoladas para `users`, `partners`, e `stores`, conforme o padrão proposto no nosso debate.
* **Passo 2.2:** Refatore o ficheiro `/client/src/pages/admin/usuarios.tsx`. Substitua as `queryKey`s antigas pelas novas chaves isoladas. Garanta que a página busque os seus próprios dados de forma independente na primeira visita.

---
**FRENTE 3: IMPLEMENTAR HEALTH CHECKS BÁSICOS**
* **Passo 3.1:** No ficheiro `/server/routes.ts`, crie um novo endpoint `GET /api/health/storage`. Este endpoint deve validar que os métodos do `storage` estão a funcionar.
* **Passo 3.2:** Crie o endpoint `GET /api/health/schema` que faz uma validação básica para garantir que as tabelas principais existem no banco de dados.

---

Execute este plano para entregar a **FASE 1: ESTABILIZAÇÃO**.