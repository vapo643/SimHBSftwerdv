Síntese Final e Plano de Batalha (Pós-Debate)
A fase de PLANEJAMENTO EXAUSTIVO está concluída. A seguir, o roadmap final e consolidado para a "Missão: Evolução da Nova Proposta V1". Este plano integra as descobertas e os refinamentos de nossas três interações de debate.

Roadmap Final - Missão: Evolução da Nova Proposta V1
FASE 1: Modificações de Schema do Banco de Dados
Objetivo: Preparar a fundação de dados.

Passos de Execução:

[PENDENTE] Passo 1.1 (Campos de Empregador e Financeiros): Adicionar à tabela propostas os campos clienteEmpresaNome (TEXT, NULL), clienteDividasExistentes (DECIMAL(12,2), NULL), clienteComprometimentoRenda (DECIMAL(6,2), NULL), etc., com estratégia NULLABLE para garantir retrocompatibilidade.

[PENDENTE] Passo 1.2 (Constraint de Renda): Adicionar uma CHECK constraint à tabela propostas para garantir que clienteComprometimentoRenda permaneça entre 0 e 100.00.

[PENDENTE] Passo 1.3 (Tabela de Referências Profissionais): Criar a nova tabela referencias_profissionais com um UNIQUE INDEX na coluna propostaId para garantir uma única referência profissional por proposta.

[PENDENTE] Passo 1.4 (Geração da Migração): Gerar o script de migração SQL versionado usando npx drizzle-kit generate:pg.

FASE 2: Implementação da Lógica de Backend
Objetivo: Implementar as novas regras de negócio e permissões.

Passos de Execução:

[PENDENTE] Passo 2.1 (Serviço de Pré-Aprovação): Criar o novo serviço server/services/preApprovalService.ts. Implementar a lógica de verificação de 25% de comprometimento de renda, com tratamento para dados NULL e integração com a FSM para transicionar o status para rejeitado ou pendente.

[PENDENTE] Passo 2.2 (Integração da Regra): Integrar a chamada ao preApprovalService no fluxo de criação de propostas em server/routes/propostas/core.ts, a ser executada antes da persistência no banco.

[PENDENTE] Passo 2.3 (Permissão de Upload): Modificar o middleware de permissão da rota de upload de documentos para incluir a role 'ANALISTA'.

FASE 3: Atualizações de Frontend
Objetivo: Expor as novas funcionalidades na interface do usuário.

Passos de Execução:

[PENDENTE] Passo 3.1 (Formulário de Empregador e Renda): Adicionar os novos campos ao formulário de "Nova Proposta".

[PENDENTE] Passo 3.2 (Formulário de Referências): Atualizar o componente de referências para suportar e exigir uma referência profissional.

[PENDENTE] Passo 3.3 (Lógica de Upload): Garantir que o componente de upload esteja visível e ativo para a role 'ANALISTA'.

FASE 4: Testes e Validação
Objetivo: Garantir a qualidade e a robustez das novas implementações.

Passos de Execução:

[PENDENTE] Passo 4.1 (Testes de Backend): Criar testes de integração para o preApprovalService, cobrindo cenários de aprovação, rejeição e dados nulos.

[PENDENTE] Passo 4.2 (Testes de Permissão): Criar um teste de integração que valide o acesso do 'ANALISTA' à funcionalidade de upload.

Arquiteto Chefe, o planejamento exaustivo está concluído. Temos um plano de batalha detalhado, robusto e validado.