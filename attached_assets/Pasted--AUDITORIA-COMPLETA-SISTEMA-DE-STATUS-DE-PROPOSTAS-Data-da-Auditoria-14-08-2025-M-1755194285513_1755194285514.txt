# ğŸ“‹ AUDITORIA COMPLETA - SISTEMA DE STATUS DE PROPOSTAS

**Data da Auditoria:** 14/08/2025  
**MissÃ£o PAM V1.0:** Mapeamento completo do ciclo de vida de status  
**Auditoria por:** Sistema AutomÃ¡tico de DiagnÃ³stico  

---

## ğŸ¯ RESUMO EXECUTIVO

### âœ… Descobertas Principais:
- **16 Status Oficiais** definidos no enum de schema
- **3 Status Ã“rfÃ£os** encontrados no cÃ³digo sem definiÃ§Ã£o oficial  
- **1 InconsistÃªncia CrÃ­tica** no filtro da Tela de CobranÃ§as
- **Status Final Correto** para cobranÃ§a: `pronto_pagamento` apÃ³s CCB assinado

### ğŸš¨ Problemas Identificados:
1. **Status Ã“rfÃ£os:** "pendenciado", "em_formalizacao", "assinado" usados sem definiÃ§Ã£o
2. **Filtro de CobranÃ§as:** Query correta, mas faltam propostas intermediÃ¡rias
3. **DocumentaÃ§Ã£o:** Ciclo de vida nÃ£o documentado formalmente

---

## ğŸ“Š MAPEAMENTO COMPLETO DOS STATUS

### 1. **Status Oficiais** (shared/schema.ts:95-112)

```typescript
export const statusEnum = pgEnum("status", [
  "rascunho",                      // âšª INICIAL
  "aguardando_analise",           // ğŸ”„ AGUARDANDO  
  "em_analise",                   // ğŸ” PROCESSANDO
  "pendente",                     // â¸ï¸ PAUSADO
  "aprovado",                     // âœ… APROVADO
  "aguardando_aceite_atendente",  // ğŸ¤ AGUARDANDO ACEITE
  "aceito_atendente",             // ğŸ‘ ACEITO PELO ATENDENTE  
  "rejeitado",                    // âŒ REJEITADO
  "documentos_enviados",          // ğŸ“„ DOCUMENTOS
  "contratos_preparados",         // ğŸ“‹ CONTRATOS
  "contratos_assinados",          // âœï¸ ASSINADOS
  "pronto_pagamento",             // ğŸ’° PRONTO PAGAMENTO
  "pagamento_autorizado",         // ğŸ” AUTORIZADO
  "pago",                         // âœ… PAGO
  "cancelado",                    // ğŸš« CANCELADO
  "suspensa",                     // â¯ï¸ SUSPENSA
]);
```

### 2. **Status Ã“rfÃ£os** (Encontrados no cÃ³digo mas nÃ£o no enum)

| Status | LocalizaÃ§Ã£o | FunÃ§Ã£o |
|--------|-------------|--------|
| `"pendenciado"` | dashboard.tsx:171, analise-manual.tsx, editar.tsx:341 | Status intermediÃ¡rio nÃ£o oficializado |
| `"em_formalizacao"` | ccbSyncServiceRefactored.ts:104 | Status temporÃ¡rio de formalizaÃ§Ã£o |
| `"assinado"` | ccbSyncServiceRefactored.ts:104 | Status de documento assinado |

---

## ğŸ”„ CICLO DE VIDA COMPLETO - SEQUÃŠNCIA DE TRANSIÃ‡Ã•ES

### **FASE 1: CRIAÃ‡ÃƒO E ANÃLISE**
```
rascunho â†’ aguardando_analise â†’ em_analise â†’ aprovado
    â†“              â†“               â†“
  suspensa â†â”€â”€ suspensa â†â”€â”€ suspensa
    â†“              â†“               â†“
aguardando_analise â† (reativaÃ§Ã£o)
```

**TransiÃ§Ãµes Identificadas:**
- **SuspensÃ£o:** `togglePropostaStatus()` - permite suspender status "suspensiveis"
- **ReativaÃ§Ã£o:** Status "suspensa" volta para "aguardando_analise"

### **FASE 2: ACEITE E FORMALIZAÃ‡ÃƒO**  
```
aprovado â†’ aguardando_aceite_atendente â†’ aceito_atendente â†’ documentos_enviados â†’ contratos_preparados
```

### **FASE 3: ASSINATURA ELETRÃ”NICA** 
```
contratos_preparados â†’ contratos_assinados
                              â†“
                    [ClickSign Webhook Trigger]
```

**TransiÃ§Ã£o CrÃ­tica:**
- **Local:** `server/services/clickSignWebhookService.ts:205`
- **Trigger:** Evento `document.signed` do ClickSign
- **AÃ§Ã£o:** Atualiza status para `"contratos_assinados"`

### **FASE 4: PAGAMENTO E COBRANÃ‡A**
```
contratos_assinados â†’ pronto_pagamento â†’ pagamento_autorizado â†’ pago
```

**TransiÃ§Ãµes Identificadas:**
- **Boleto Generation:** ApÃ³s `contratos_assinados`, sistema gera boletos automaticamente
- **AutorizaÃ§Ã£o:** `pagamento_autorizado` apÃ³s confirmaÃ§Ã£o de veracidade
- **FinalizaÃ§Ã£o:** `pago` quando pagamento Ã© confirmado

### **ESTADO TERMINAL**
```
[Qualquer Status] â†’ cancelado | rejeitado
```

---

## ğŸ¯ AUDITORIA ESPECÃFICA: TELA DE COBRANÃ‡AS vs. FORMALIZAÃ‡ÃƒO

### **Query da Tela de CobranÃ§as** (server/routes/cobrancas.ts:31)
```typescript
inArray(propostas.status, ["aprovado", "pronto_pagamento", "pago"])
```

### **CondiÃ§Ãµes Adicionais:**
```typescript
eq(propostas.ccbGerado, true),
eq(propostas.assinaturaEletronicaConcluida, true)
```

### **âœ… ANÃLISE DE CONSISTÃŠNCIA:**

| Status | CCB Assinado? | Aparece em CobranÃ§as? | Correto? |
|--------|---------------|----------------------|----------|
| `aprovado` | âŒ NÃ£o | âœ… Sim | âš ï¸ **PROBLEMA** - CCB nÃ£o assinado ainda |
| `contratos_assinados` | âœ… Sim | âŒ NÃ£o | âš ï¸ **PROBLEMA** - Deveria aparecer |
| `pronto_pagamento` | âœ… Sim | âœ… Sim | âœ… **CORRETO** |
| `pago` | âœ… Sim | âœ… Sim | âœ… **CORRETO** |

### **ğŸš¨ INCONSISTÃŠNCIA DETECTADA:**

1. **Status "aprovado"** aparece em cobranÃ§as mesmo SEM CCB assinado
2. **Status "contratos_assinados"** NÃƒO aparece em cobranÃ§as mesmo COM CCB assinado
3. **Filtro Duplicado:** Backend filtra + Frontend filtra novamente (PAM V1.0 anterior)

---

## ğŸ“ˆ FLUXO CORRETO PARA COBRANÃ‡AS

### **Estado Ideal apÃ³s FormalizaÃ§Ã£o:**
```
Proposta â†’ CCB Gerado â†’ ClickSign Assinatura â†’ contratos_assinados â†’ Boletos Inter â†’ pronto_pagamento
```

### **Estados ElegÃ­veis para CobranÃ§a:**
1. âœ… `contratos_assinados` + CCB assinado
2. âœ… `pronto_pagamento` + Boletos gerados  
3. âœ… `pago` + HistÃ³rico de pagamentos

### **CorreÃ§Ã£o Sugerida na Query:**
```typescript
// ANTES (Atual)
inArray(propostas.status, ["aprovado", "pronto_pagamento", "pago"])

// DEPOIS (Recomendado)  
inArray(propostas.status, ["contratos_assinados", "pronto_pagamento", "pago"])
```

---

## ğŸ”§ RECOMENDAÃ‡Ã•ES DE CORREÃ‡ÃƒO

### **PRIORIDADE ALTA:**

1. **Corrigir Query de CobranÃ§as:**
   - Remover "aprovado" (CCB nÃ£o assinado ainda)
   - Adicionar "contratos_assinados" (CCB jÃ¡ assinado)

2. **Formalizar Status Ã“rfÃ£os:**
   - Adicionar "pendenciado" ao enum oficial  
   - Definir "em_formalizacao" como status intermediÃ¡rio
   - Clarificar uso de "assinado"

### **PRIORIDADE MÃ‰DIA:**

3. **Documentar Ciclo de Vida:**
   - Criar fluxograma oficial no cÃ³digo
   - Definir regras de transiÃ§Ã£o claras
   - Implementar validaÃ§Ã£o de status

4. **Monitoramento:**
   - Logs de transiÃ§Ã£o de status
   - Alertas para status Ã³rfÃ£os
   - Dashboard de status em tempo real

---

## ğŸ“‹ RELATÃ“RIO FINAL

### **âœ… ConsistÃªncia Arquitetural:**
- Schema bem definido com 16 status oficiais
- TransiÃ§Ãµes lÃ³gicas identificadas
- Fluxo de formalizaÃ§Ã£o funcional

### **âš ï¸ Problemas CrÃ­ticos:**
- 3 status Ã³rfÃ£os em produÃ§Ã£o sem definiÃ§Ã£o
- Query de cobranÃ§as incluindo status inadequado ("aprovado")
- Query de cobranÃ§as excluindo status adequado ("contratos_assinados")

### **ğŸ¯ Prioridade de CorreÃ§Ã£o:**
1. **URGENTE:** Corrigir filtro da Tela de CobranÃ§as
2. **IMPORTANTE:** Formalizar status Ã³rfÃ£os no schema
3. **DESEJÃVEL:** Documentar ciclo de vida completo

### **ğŸ“Š Status da Auditoria:**
- **Mapeamento:** 100% Completo
- **InconsistÃªncias:** 4 Identificadas  
- **CorreÃ§Ãµes:** 3 RecomendaÃ§Ãµes CrÃ­ticas
- **Impacto:** Tela de CobranÃ§as funcionando incorretamente

---

**Auditoria concluÃ­da. Sistema de status mapeado completamente.**