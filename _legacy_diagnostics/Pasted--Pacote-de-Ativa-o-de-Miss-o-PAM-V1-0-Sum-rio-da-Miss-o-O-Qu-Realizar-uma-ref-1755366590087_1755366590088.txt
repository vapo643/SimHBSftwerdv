**### Pacote de Ativação de Missão (PAM) V1.0**

* **Sumário da Missão (O Quê):** Realizar uma refatoração completa e multifacetada da "Ficha do Cliente" para corrigir todas as quatro falhas críticas identificadas na auditoria (mismatch de campos, dados ausentes, status desatualizado e funcionalidade ausente).
* **Intenção Estratégica (O Porquê):** Para transformar a Ficha do Cliente na ferramenta de trabalho principal e 100% confiável da nossa equipe de cobranças, garantindo que todas as informações e ações estejam precisas, em tempo real e funcionais.
* **Histórico Relevante (Consulta Obrigatória):** Use o seu relatório de auditoria forense `PAM_V1.0_AUDITORIA_FORENSE_FICHA_CLIENTE.md` como a única fonte da verdade e o mapa de correção para esta missão. Sua tarefa é corrigir todas as "Causas Raiz Identificadas".
* **Modelo Mental (Como se Encaixa):** Você atuará como Engenheiro Full-Stack Sênior. A missão exigirá modificações coordenadas no backend (para corrigir a busca de dados e adicionar novas funcionalidades) e no frontend (para consumir os dados corretos e conectar as novas ações).
* **Riscos Antecipados:** **Risco:** Múltiplas chamadas em tempo real para a API do Inter podem deixar a UI lenta. **Contramedida:** A busca em tempo real deve ser acionada de forma inteligente (ex: ao abrir a ficha ou ao clicar em um botão "Sincronizar"), com estados de carregamento claros para o usuário.

---

**IMPLEMENTAR:**
A refatoração completa da "Ficha do Cliente" e de seus serviços de backend.

**CURRENT STATE:**
A ficha está com funcionalidades críticas quebradas: botões de cópia não funcionam, downloads falham e os status das parcelas são estáticos e não confiáveis.

**EXPECTED (Estado Final de Sucesso):**
Uma "Ficha do Cliente" 100% funcional:
1.  Os botões "Copiar PIX" e "Copiar Linha Digitável" funcionam para **TODAS** as parcelas.
2.  O botão "Baixar Boleto" funciona para **TODAS** as parcelas.
3.  O status de cada parcela (`PAGO`, `VENCIDO`, etc.) é um reflexo **em tempo real** do estado no Banco Inter.
4.  O operador de cobranças tem um novo botão para **"Marcar como Pago"** manualmente em cada parcela, como um fallback.

**CONSTRAINTS (Roadmap de Implementação Faseado):**

**FASE 1: Correção do Mapeamento de Dados (Backend):**
    - **Ação:** No endpoint `GET /api/cobrancas/:propostaId/ficha`, refatore a lógica que busca e mapeia os dados das parcelas.
    - **Implementação:**
        a. Garanta que o campo `codigoSolicitacao` da tabela `inter_collections` seja incluído no objeto de cada parcela retornada.
        b. Corrija o **mismatch de campos**: renomeie os campos no objeto de retorno para que o frontend receba os nomes que ele espera (ex: `pixCopiaECola` em vez de `interPixCopiaECola`).

**FASE 2: Implementação da Sincronização em Tempo Real (Backend):**
    - **Ação:** No mesmo endpoint, implemente a busca de status em tempo real.
    - **Implementação:** Dentro do loop que processa cada parcela, adicione uma chamada `await interBankService.recuperarCobranca(parcela.codigoSolicitacao)`. Use o `situacao` retornado por esta chamada como a fonte da verdade para o status da parcela que você envia para o frontend.

**FASE 3: Implementação da Ação Manual (Full-Stack):**
    - **Ação (Backend):** Crie um novo endpoint `PATCH /api/cobrancas/parcelas/:codigoSolicitacao/marcar-pago`.
    - **Implementação (Backend):** Este endpoint deve ser protegido por `role` e, ao ser chamado, deve atualizar a `situacao` da parcela correspondente em nossa tabela `inter_collections` para `PAGO` e registrar um log de auditoria.
    - **Ação (Frontend):** Adicione o botão "Marcar como Pago" a cada parcela na UI da Ficha do Cliente. Conecte este botão para que ele chame o novo endpoint.

**FASE 4: Validação Final do Frontend:**
    - **Ação:** Revise o componente `CobrancasPage.tsx`.
    - **Implementação:** Garanta que, com as correções de backend, os botões "Copiar" e "Baixar" agora recebem os dados corretos e estão 100% funcionais. Confirme que o status exibido é o status em tempo real.

**PROTOCOLO OBRIGATÓRIO 7-CHECK EXPANDIDO:**
Siga o protocolo completo, com foco especial no teste funcional ponta-a-ponta de cada uma das quatro funcionalidades corrigidas/implementadas.
---
**DECLARAÇÃO DE INCERTEZA (OBRIGATÓRIO):**
Preencha a declaração completa ao final da sua implementação.
---