# 📋 AUDITORIA COMPLETA - SISTEMA DE STATUS DE PROPOSTAS

**Data da Auditoria:** 14/08/2025  
**Missão PAM V1.0:** Mapeamento completo do ciclo de vida de status  
**Auditoria por:** Sistema Automático de Diagnóstico  

---

## 🎯 RESUMO EXECUTIVO

### ✅ Descobertas Principais:
- **16 Status Oficiais** definidos no enum de schema
- **3 Status Órfãos** encontrados no código sem definição oficial  
- **1 Inconsistência Crítica** no filtro da Tela de Cobranças
- **Status Final Correto** para cobrança: `pronto_pagamento` após CCB assinado

### 🚨 Problemas Identificados:
1. **Status Órfãos:** "pendenciado", "em_formalizacao", "assinado" usados sem definição
2. **Filtro de Cobranças:** Query correta, mas faltam propostas intermediárias
3. **Documentação:** Ciclo de vida não documentado formalmente

---

## 📊 MAPEAMENTO COMPLETO DOS STATUS

### 1. **Status Oficiais** (shared/schema.ts:95-112)

```typescript
export const statusEnum = pgEnum("status", [
  "rascunho",                      // ⚪ INICIAL
  "aguardando_analise",           // 🔄 AGUARDANDO  
  "em_analise",                   // 🔍 PROCESSANDO
  "pendente",                     // ⏸️ PAUSADO
  "aprovado",                     // ✅ APROVADO
  "aguardando_aceite_atendente",  // 🤝 AGUARDANDO ACEITE
  "aceito_atendente",             // 👍 ACEITO PELO ATENDENTE  
  "rejeitado",                    // ❌ REJEITADO
  "documentos_enviados",          // 📄 DOCUMENTOS
  "contratos_preparados",         // 📋 CONTRATOS
  "contratos_assinados",          // ✍️ ASSINADOS
  "pronto_pagamento",             // 💰 PRONTO PAGAMENTO
  "pagamento_autorizado",         // 🔐 AUTORIZADO
  "pago",                         // ✅ PAGO
  "cancelado",                    // 🚫 CANCELADO
  "suspensa",                     // ⏯️ SUSPENSA
]);
```

### 2. **Status Órfãos** (Encontrados no código mas não no enum)

| Status | Localização | Função |
|--------|-------------|--------|
| `"pendenciado"` | dashboard.tsx:171, analise-manual.tsx, editar.tsx:341 | Status intermediário não oficializado |
| `"em_formalizacao"` | ccbSyncServiceRefactored.ts:104 | Status temporário de formalização |
| `"assinado"` | ccbSyncServiceRefactored.ts:104 | Status de documento assinado |

---

## 🔄 CICLO DE VIDA COMPLETO - SEQUÊNCIA DE TRANSIÇÕES

### **FASE 1: CRIAÇÃO E ANÁLISE**
```
rascunho → aguardando_analise → em_analise → aprovado
    ↓              ↓               ↓
  suspensa ←── suspensa ←── suspensa
    ↓              ↓               ↓
aguardando_analise ← (reativação)
```

**Transições Identificadas:**
- **Suspensão:** `togglePropostaStatus()` - permite suspender status "suspensiveis"
- **Reativação:** Status "suspensa" volta para "aguardando_analise"

### **FASE 2: ACEITE E FORMALIZAÇÃO**  
```
aprovado → aguardando_aceite_atendente → aceito_atendente → documentos_enviados → contratos_preparados
```

### **FASE 3: ASSINATURA ELETRÔNICA** 
```
contratos_preparados → contratos_assinados
                              ↓
                    [ClickSign Webhook Trigger]
```

**Transição Crítica:**
- **Local:** `server/services/clickSignWebhookService.ts:205`
- **Trigger:** Evento `document.signed` do ClickSign
- **Ação:** Atualiza status para `"contratos_assinados"`

### **FASE 4: PAGAMENTO E COBRANÇA**
```
contratos_assinados → pronto_pagamento → pagamento_autorizado → pago
```

**Transições Identificadas:**
- **Boleto Generation:** Após `contratos_assinados`, sistema gera boletos automaticamente
- **Autorização:** `pagamento_autorizado` após confirmação de veracidade
- **Finalização:** `pago` quando pagamento é confirmado

### **ESTADO TERMINAL**
```
[Qualquer Status] → cancelado | rejeitado
```

---

## 🎯 AUDITORIA ESPECÍFICA: TELA DE COBRANÇAS vs. FORMALIZAÇÃO

### **Query da Tela de Cobranças** (server/routes/cobrancas.ts:31)
```typescript
inArray(propostas.status, ["aprovado", "pronto_pagamento", "pago"])
```

### **Condições Adicionais:**
```typescript
eq(propostas.ccbGerado, true),
eq(propostas.assinaturaEletronicaConcluida, true)
```

### **✅ ANÁLISE DE CONSISTÊNCIA:**

| Status | CCB Assinado? | Aparece em Cobranças? | Correto? |
|--------|---------------|----------------------|----------|
| `aprovado` | ❌ Não | ✅ Sim | ⚠️ **PROBLEMA** - CCB não assinado ainda |
| `contratos_assinados` | ✅ Sim | ❌ Não | ⚠️ **PROBLEMA** - Deveria aparecer |
| `pronto_pagamento` | ✅ Sim | ✅ Sim | ✅ **CORRETO** |
| `pago` | ✅ Sim | ✅ Sim | ✅ **CORRETO** |

### **🚨 INCONSISTÊNCIA DETECTADA:**

1. **Status "aprovado"** aparece em cobranças mesmo SEM CCB assinado
2. **Status "contratos_assinados"** NÃO aparece em cobranças mesmo COM CCB assinado
3. **Filtro Duplicado:** Backend filtra + Frontend filtra novamente (PAM V1.0 anterior)

---

## 📈 FLUXO CORRETO PARA COBRANÇAS

### **Estado Ideal após Formalização:**
```
Proposta → CCB Gerado → ClickSign Assinatura → contratos_assinados → Boletos Inter → pronto_pagamento
```

### **Estados Elegíveis para Cobrança:**
1. ✅ `contratos_assinados` + CCB assinado
2. ✅ `pronto_pagamento` + Boletos gerados  
3. ✅ `pago` + Histórico de pagamentos

### **Correção Sugerida na Query:**
```typescript
// ANTES (Atual)
inArray(propostas.status, ["aprovado", "pronto_pagamento", "pago"])

// DEPOIS (Recomendado)  
inArray(propostas.status, ["contratos_assinados", "pronto_pagamento", "pago"])
```

---

## 🔧 RECOMENDAÇÕES DE CORREÇÃO

### **PRIORIDADE ALTA:**

1. **Corrigir Query de Cobranças:**
   - Remover "aprovado" (CCB não assinado ainda)
   - Adicionar "contratos_assinados" (CCB já assinado)

2. **Formalizar Status Órfãos:**
   - Adicionar "pendenciado" ao enum oficial  
   - Definir "em_formalizacao" como status intermediário
   - Clarificar uso de "assinado"

### **PRIORIDADE MÉDIA:**

3. **Documentar Ciclo de Vida:**
   - Criar fluxograma oficial no código
   - Definir regras de transição claras
   - Implementar validação de status

4. **Monitoramento:**
   - Logs de transição de status
   - Alertas para status órfãos
   - Dashboard de status em tempo real

---

## 📋 RELATÓRIO FINAL

### **✅ Consistência Arquitetural:**
- Schema bem definido com 16 status oficiais
- Transições lógicas identificadas
- Fluxo de formalização funcional

### **⚠️ Problemas Críticos:**
- 3 status órfãos em produção sem definição
- Query de cobranças incluindo status inadequado ("aprovado")
- Query de cobranças excluindo status adequado ("contratos_assinados")

### **🎯 Prioridade de Correção:**
1. **URGENTE:** Corrigir filtro da Tela de Cobranças
2. **IMPORTANTE:** Formalizar status órfãos no schema
3. **DESEJÁVEL:** Documentar ciclo de vida completo

### **📊 Status da Auditoria:**
- **Mapeamento:** 100% Completo
- **Inconsistências:** 4 Identificadas  
- **Correções:** 3 Recomendações Críticas
- **Impacto:** Tela de Cobranças funcionando incorretamente

---

**Auditoria concluída. Sistema de status mapeado completamente.**