# üìã BLUEPRINT: Modal de Preenchimento Autom√°tico CPF

**PROTOCOLO:** PAM V1.0 - Opera√ß√£o Acelera√ß√£o de Origina√ß√£o (TRACK 1, FASE 2)  
**MISS√ÉO:** Arquitetura UX/UI para Substitui√ß√£o de `window.confirm()`  
**DATA:** 2025-09-03  
**ARQUITETO:** Replit Agent AI

---

## üéØ SUM√ÅRIO EXECUTIVO

**OBJETIVO:** Substituir o `window.confirm()` existente no componente `ClientDataStep.tsx` por um modal customizado utilizando a biblioteca `shadcn/ui`, proporcionando uma experi√™ncia de usu√°rio superior, consistente e profissional.

**IMPACTO ESPERADO:**

- ‚úÖ UX profissional alinhada com o design system
- ‚úÖ Controle total sobre estilo e comportamento
- ‚úÖ Melhor acessibilidade e responsividade
- ‚úÖ Integra√ß√£o nativa com o theme da aplica√ß√£o

---

## üîç AN√ÅLISE T√âCNICA

### **Estado Atual (Current State)**

**Localiza√ß√£o:** `client/src/components/propostas/ClientDataStep.tsx` (linhas 172-174)

```typescript
// PROBLEMA: Uso de window.confirm() - interface gen√©rica e inconsistente
const userConfirmed = window.confirm(
  `Cliente j√° cadastrado!\n\nEncontramos dados de: ${data.nome}\n\nDeseja usar os dados existentes para esta nova proposta?`
);

if (userConfirmed) {
  // L√≥gica de preenchimento (funcional)
  updateClient({ ...data });
  toast({ title: 'Dados carregados!', description: '...' });
}
```

**Problemas Identificados:**

- ‚ùå Interface visualmente inconsistente com o design system
- ‚ùå Limita√ß√µes de styling e customiza√ß√£o
- ‚ùå Experi√™ncia de usu√°rio inadequada para aplica√ß√£o banc√°ria
- ‚ùå Bloqueio do thread principal do navegador
- ‚ùå N√£o responsivo em dispositivos m√≥veis

---

## üé® ARQUITETURA DA SOLU√á√ÉO

### **1. Sele√ß√£o de Componente**

**RECOMENDA√á√ÉO:** `AlertDialog` (shadcn/ui)

**JUSTIFICATIVA T√âCNICA:**

- ‚úÖ **Comportamento Correto:** Exige resposta expl√≠cita do usu√°rio (n√£o pode ser fechado acidentalmente)
- ‚úÖ **Sem√¢ntica Apropriada:** `role="alertdialog"` para leitores de tela
- ‚úÖ **Acessibilidade Avan√ßada:** Foco inicial no bot√£o seguro (Cancelar)
- ‚úÖ **Componente J√° Dispon√≠vel:** `ConfirmationDialog.tsx` existente pode ser reutilizado

**Compara√ß√£o AlertDialog vs Dialog:**

| Aspecto                       | AlertDialog              | Dialog                |
| ----------------------------- | ------------------------ | --------------------- |
| **Fechamento ao clicar fora** | ‚ùå N√£o                   | ‚úÖ Sim                |
| **Resposta obrigat√≥ria**      | ‚úÖ Sim                   | ‚ùå N√£o                |
| **Uso recomendado**           | ‚úÖ Confirma√ß√µes cr√≠ticas | ‚ùå Formul√°rios gerais |
| **Papel ARIA**                | `alertdialog`            | `dialog`              |

---

### **2. Estrat√©gia de Gest√£o de Estado**

**MODELO DE ESTADO REATIVO:**

```typescript
// Estados adicionais no ClientDataStep.tsx
const [clientFoundData, setClientFoundData] = useState<ClientDataApiResponse['data'] | null>(null);
const [showClientConfirmDialog, setShowClientConfirmDialog] = useState(false);

// Fluxo de controle
1. Busca da API ‚Üí Armazena dados no estado
2. Ativa modal ‚Üí Usu√°rio toma decis√£o
3. A√ß√£o confirmada ‚Üí Preenche formul√°rio + fecha modal
4. A√ß√£o cancelada ‚Üí Apenas fecha modal
```

**VANTAGENS:**

- ‚úÖ Estado reativo e controlado
- ‚úÖ Separa√ß√£o clara entre dados e UI
- ‚úÖ F√°cil testabilidade
- ‚úÖ Performance otimizada (n√£o bloqueia thread)

---

### **3. Design do Componente**

#### **3.1 Reutiliza√ß√£o vs. Cria√ß√£o**

**RECOMENDA√á√ÉO:** Reutilizar `ConfirmationDialog` existente com pequenos ajustes

**AN√ÅLISE DO COMPONENTE EXISTENTE:**

```typescript
// ConfirmationDialog j√° possui API completa:
interface ConfirmationDialogProps {
  isOpen: boolean; // ‚úÖ Controle de visibilidade
  onClose: () => void; // ‚úÖ Callback de fechamento
  onConfirm: () => void; // ‚úÖ Callback de confirma√ß√£o
  title: string; // ‚úÖ T√≠tulo customiz√°vel
  description: string; // ‚úÖ Descri√ß√£o customiz√°vel
  confirmText?: string; // ‚úÖ Texto do bot√£o de a√ß√£o
  cancelText?: string; // ‚úÖ Texto do bot√£o de cancelar
  variant?: 'destructive' | 'default'; // ‚úÖ Variante visual
  isLoading?: boolean; // ‚úÖ Estado de carregamento
}
```

#### **3.2 Props Espec√≠ficas para o Caso de Uso**

```typescript
// Configura√ß√£o otimizada para nosso caso:
const clientConfirmDialogProps = {
  isOpen: showClientConfirmDialog,
  onClose: () => setShowClientConfirmDialog(false),
  onConfirm: handleUseExistingClientData,
  title: 'Cliente Encontrado',
  description: `Encontramos dados de: ${clientFoundData?.nome}\n\nDeseja preencher a proposta com os dados existentes?`,
  confirmText: 'Usar Dados',
  cancelText: 'N√£o Usar',
  variant: 'default' as const,
  isLoading: loadingCpfData,
};
```

#### **3.3 Conte√∫do Visual Otimizado**

**T√çTULO:** "Cliente Encontrado"  
**DESCRI√á√ÉO:** "Encontramos dados de: **[Nome do Cliente]**\n\nDeseja preencher a proposta com os dados existentes?"  
**BOT√ÉO PRIM√ÅRIO:** "Usar Dados" (a√ß√£o positiva)  
**BOT√ÉO SECUND√ÅRIO:** "N√£o Usar" (a√ß√£o segura - foco inicial)  
**√çCONE:** ‚úÖ √çcone de usu√°rio ou checkmark para refor√ßar positividade

---

## üîß PLANO DE IMPLEMENTA√á√ÉO

### **4. Refatora√ß√£o do ClientDataStep.tsx**

#### **4.1 Importa√ß√µes Adicionais**

```typescript
// ADICIONAR no topo do arquivo:
import ConfirmationDialog from '@/components/ui/ConfirmationDialog';
```

#### **4.2 Estados Adicionais**

```typescript
// ADICIONAR ap√≥s os estados existentes:
const [clientFoundData, setClientFoundData] = useState<ClientDataApiResponse['data'] | null>(null);
const [showClientConfirmDialog, setShowClientConfirmDialog] = useState(false);
```

#### **4.3 Refatora√ß√£o da Fun√ß√£o fetchClientDataByCpf**

**ANTES:**

```typescript
const fetchClientDataByCpf = useCallback(
  async (cpf: string) => {
    // ... c√≥digo de busca ...

    if (response && response.exists && response.data) {
      const data = response.data;

      // ‚ùå REMOVER: window.confirm()
      const userConfirmed = window.confirm(
        `Cliente j√° cadastrado!\n\nEncontramos dados de: ${data.nome}\n\nDeseja usar os dados existentes para esta nova proposta?`
      );

      if (userConfirmed) {
        updateClient({ ...dados... });
        toast({ title: 'Dados carregados!', description: '...' });
      }
    }
  },
  [updateClient, toast]
);
```

**DEPOIS:**

```typescript
const fetchClientDataByCpf = useCallback(
  async (cpf: string) => {
    const cleanCPF = cpf.replace(/\D/g, '');
    if (cleanCPF.length !== 11) return;

    setLoadingCpfData(true);
    try {
      const response = (await apiRequest(`/api/clientes/cpf/${cleanCPF}`, {
        method: 'GET',
      })) as ClientDataApiResponse;

      if (response && response.exists && response.data) {
        // ‚úÖ NOVO: Armazenar dados e abrir modal
        setClientFoundData(response.data);
        setShowClientConfirmDialog(true);
      }
    } catch (error) {
      console.error('Erro ao buscar dados do cliente:', error);
    } finally {
      setLoadingCpfData(false);
    }
  },
  [setClientFoundData, setShowClientConfirmDialog]
);
```

#### **4.4 Nova Fun√ß√£o de Confirma√ß√£o**

```typescript
// ‚úÖ ADICIONAR: Handler para confirma√ß√£o do modal
const handleUseExistingClientData = useCallback(() => {
  if (!clientFoundData) return;

  // Mesmo c√≥digo de preenchimento existente
  updateClient({
    nome: clientFoundData.nome || '',
    email: clientFoundData.email || '',
    telefone: clientFoundData.telefone || '',
    dataNascimento: clientFoundData.dataNascimento || '',
    rg: clientFoundData.rg || '',
    orgaoEmissor: clientFoundData.orgaoEmissor || '',
    rgUf: clientFoundData.rgUf || '',
    rgDataEmissao: clientFoundData.rgDataEmissao || '',
    localNascimento: clientFoundData.localNascimento || '',
    estadoCivil: clientFoundData.estadoCivil || '',
    nacionalidade: clientFoundData.nacionalidade || '',
    cep: clientFoundData.cep || '',
    logradouro: clientFoundData.logradouro || '',
    numero: clientFoundData.numero || '',
    complemento: clientFoundData.complemento || '',
    bairro: clientFoundData.bairro || '',
    cidade: clientFoundData.cidade || '',
    estado: clientFoundData.estado || '',
    ocupacao: clientFoundData.ocupacao || '',
    rendaMensal: clientFoundData.rendaMensal || '',
    telefoneEmpresa: clientFoundData.telefoneEmpresa || '',
    metodoPagamento:
      (clientFoundData.metodoPagamento as 'conta_bancaria' | 'pix') || 'conta_bancaria',
    dadosPagamentoBanco: clientFoundData.dadosPagamentoBanco || '',
    dadosPagamentoAgencia: clientFoundData.dadosPagamentoAgencia || '',
    dadosPagamentoConta: clientFoundData.dadosPagamentoConta || '',
    dadosPagamentoDigito: clientFoundData.dadosPagamentoDigito || '',
    dadosPagamentoPix: clientFoundData.dadosPagamentoPix || '',
    dadosPagamentoTipoPix: clientFoundData.dadosPagamentoTipoPix || '',
    dadosPagamentoPixBanco: clientFoundData.dadosPagamentoPixBanco || '',
    dadosPagamentoPixNomeTitular: clientFoundData.dadosPagamentoPixNomeTitular || '',
    dadosPagamentoPixCpfTitular: clientFoundData.dadosPagamentoPixCpfTitular || '',
  });

  toast({
    title: 'Dados carregados!',
    description: 'Dados do cliente preenchidos automaticamente.',
  });

  // Fechar modal e limpar dados tempor√°rios
  setShowClientConfirmDialog(false);
  setClientFoundData(null);
}, [clientFoundData, updateClient, toast]);
```

#### **4.5 Renderiza√ß√£o do Modal**

```typescript
// ‚úÖ ADICIONAR no final do return, antes do fechamento da div principal:
return (
  <div className="space-y-6">
    {/* ... todo o conte√∫do existente ... */}

    {/* Modal de Confirma√ß√£o de Cliente Encontrado */}
    <ConfirmationDialog
      isOpen={showClientConfirmDialog}
      onClose={() => {
        setShowClientConfirmDialog(false);
        setClientFoundData(null);
      }}
      onConfirm={handleUseExistingClientData}
      title="Cliente Encontrado"
      description={`Encontramos dados de: ${clientFoundData?.nome || 'Cliente'}\n\nDeseja preencher a proposta com os dados existentes?`}
      confirmText="Usar Dados"
      cancelText="N√£o Usar"
      variant="default"
      isLoading={loadingCpfData}
    />
  </div>
);
```

---

## üìã CHECKLIST DE IMPLEMENTA√á√ÉO

### **Fase 1: Prepara√ß√£o**

- [ ] ‚úÖ Verificar que `ConfirmationDialog` est√° dispon√≠vel
- [ ] ‚úÖ Confirmar imports do `@/components/ui/alert-dialog`
- [ ] üîç Analisar se h√° conflitos de estado existentes

### **Fase 2: Refatora√ß√£o**

- [ ] üîß Adicionar estados `clientFoundData` e `showClientConfirmDialog`
- [ ] üîß Refatorar fun√ß√£o `fetchClientDataByCpf`
- [ ] üîß Implementar `handleUseExistingClientData`
- [ ] üîß Adicionar renderiza√ß√£o do `ConfirmationDialog`

### **Fase 3: Testes**

- [ ] üß™ Testar fluxo completo com CPF demo (12345678901)
- [ ] üß™ Testar cancelamento do modal
- [ ] üß™ Verificar responsividade em mobile
- [ ] üß™ Validar acessibilidade (navega√ß√£o por teclado)

### **Fase 4: Polimento**

- [ ] üé® Ajustar textos se necess√°rio
- [ ] üé® Considerar √≠cones adicionais (User, CheckCircle)
- [ ] üìù Atualizar documenta√ß√£o/coment√°rios
- [ ] üîç Code review e otimiza√ß√£o

---

## üéØ BENEF√çCIOS ESPERADOS

### **Experi√™ncia do Usu√°rio**

- ‚úÖ **Interface Consistente:** Alinhada com design system da aplica√ß√£o
- ‚úÖ **Acessibilidade Aprimorada:** Navega√ß√£o por teclado, ARIA labels
- ‚úÖ **Responsividade:** Funciona perfeitamente em desktop e mobile
- ‚úÖ **Feedback Visual:** Estados de loading e transi√ß√µes suaves

### **Experi√™ncia do Desenvolvedor**

- ‚úÖ **Manutenibilidade:** C√≥digo mais limpo e organizando
- ‚úÖ **Testabilidade:** Estados control√°veis e isolados
- ‚úÖ **Reutiliza√ß√£o:** Aproveita componente existente
- ‚úÖ **Typing:** TypeScript robusto com tipos bem definidos

### **Performance**

- ‚úÖ **N√£o-Bloqueante:** Remove bloqueio do thread principal
- ‚úÖ **Otimizada:** Re-renders controlados via React state
- ‚úÖ **Mem√≥ria:** Estados tempor√°rios s√£o limpos adequadamente

---

## üö® CONSIDERA√á√ïES DE SEGURAN√áA

### **Dados Sens√≠veis**

- ‚úÖ **Mascaramento PII:** Dados j√° v√™m mascarados da API
- ‚úÖ **Estado Tempor√°rio:** `clientFoundData` √© limpo ap√≥s uso
- ‚úÖ **N√£o Persist√™ncia:** Modal n√£o persiste dados between sessions

### **Acessibilidade**

- ‚úÖ **Focus Management:** AlertDialog gerencia foco automaticamente
- ‚úÖ **Screen Readers:** ARIA labels e descriptions nativas
- ‚úÖ **Keyboard Navigation:** ESC fecha, Tab navega, Enter confirma

---

## üìä M√âTRICAS DE SUCESSO

### **Quantitativas**

- üéØ **Zero regress√µes** no fluxo de preenchimento existente
- üéØ **100% responsividade** em dispositivos mobile/tablet/desktop
- üéØ **Acessibilidade** WCAG 2.1 AA compliance

### **Qualitativas**

- üéØ **UX profissional** alinhada com padr√µes banc√°rios
- üéØ **C√≥digo maint√≠vel** seguindo patterns da aplica√ß√£o
- üéØ **Performance** sem degrada√ß√£o percept√≠vel

---

## üîÆ EXTENS√ïES FUTURAS

### **Curto Prazo (Opcional)**

- üí° **√çcones Contextuais:** User icon, CheckCircle para refor√ßar positivit√†
- üí° **Anima√ß√µes Suaves:** Micro-interactions para melhor feedback
- üí° **Preset Messages:** Templates de mensagem baseados no tipo de cliente

### **M√©dio Prazo (Roadmap)**

- üí° **Preview de Dados:** Mostrar resumo dos dados no modal antes de confirmar
- üí° **Hist√≥rico:** "Este cliente tem X propostas anteriores"
- üí° **Campos Seletivos:** Permitir escolher quais campos preencher

---

**ASSINATURA DIGITAL:** PAM V1.0 ‚úì DECD V1.0 ‚úì CONTEXTO V2.0 ‚úì  
**BLUEPRINT APROVADO:** 2025-09-03 00:35:00 UTC

---

_Este blueprint est√° pronto para implementa√ß√£o seguindo as pr√°ticas de engenharia estabelecidas no projeto Simpix._
