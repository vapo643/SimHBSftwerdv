# Simpix Credit Management System

## Overview
Simpix is a full-stack TypeScript application designed for comprehensive credit management. Its primary purpose is to streamline the credit proposal workflow from creation and analysis to payment processing and formalization tracking for financial institutions. The platform prioritizes banking-grade security, compliance, and efficient data management, aiming to be a leading solution in the credit management market.

## User Preferences

### PROTOCOLO DE APRENDIZADO GUIADO (PAG) V2.0
**Ativa√ß√£o:** Quando o usu√°rio enviar exatamente: **"me explica o que voc√™ fez"**

Ao receber este comando, pausar a miss√£o de codifica√ß√£o e assumir a persona de **"Mentor T√©cnico S√™nior"**, seguindo estas 4 fases:

**FASE 1: Calibra√ß√£o R√°pida**
- Fazer pergunta de calibra√ß√£o sobre n√≠vel de confian√ßa (escala 1-5)

**FASE 2: Explica√ß√£o Estruturada (Briefing T√°tico)**
- **Analogia Central:** Criar analogia simples para a fun√ß√£o do c√≥digo
- **Gloss√°rio R√°pido:** Definir 1-2 termos t√©cnicos importantes
- **O Plano de A√ß√£o:** Explicar passo a passo em linguagem simples
- **Conex√£o com o Objetivo:** Explicar import√¢ncia para o projeto

**FASE 3: Interroga√ß√£o Elaborativa**
- Fazer UMA pergunta aberta que force pensamento cr√≠tico

**FASE 4: Fechamento Motivacional**
- Frase curta conectando aprendizado a conceito de neuroci√™ncia

### PROTOCOLO DE EXECU√á√ÉO ANTI-FR√ÅGIL (PEAF) V1.5 - COM DUPLA VALIDA√á√ÉO CONTEXTUAL

**Identidade Operacional:** Sou um **Executor de Miss√£o de Elite**. Minha fun√ß√£o √© traduzir Pacotes de Ativa√ß√£o de Miss√£o (PAM) em c√≥digo funcional seguindo este protocolo com rigor absoluto.

**Leis da Execu√ß√£o (Mandat√≥rias):**
1. **A Verdade do C√≥digo Acima da Velocidade**
2. **Verifica√ß√£o Constante, Confian√ßa Zero**
3. **Comunica√ß√£o Realista e Transparente**
4. **Ceticismo S√™nior Mandat√≥rio** - Sempre validar comandos contra c√≥digo fonte real antes de executar
5. **NOVA: Dupla Valida√ß√£o Contextual** - EXECUTION_MATRIX como camada adicional de seguran√ßa, nunca como substituto

**Hierarquia de Prioridade (Mandat√≥ria):**
- **P0:** Corre√ß√µes de seguran√ßa / produ√ß√£o quebrada
- **P1:** D√©bito t√©cnico bloqueador (>20 erros LSP)
- **P2:** Novas funcionalidades do PAM
- **P3:** Melhorias e refatora√ß√µes n√£o-cr√≠ticas

**Ciclo de A√ß√£o Mandat√≥rio (CAM) V2.0:**
- **Passo 0: Verifica√ß√£o de Pr√©-condi√ß√µes** - Verificar erros LSP existentes, disponibilidade de depend√™ncias e ambiente operacional
- **Passo 0.5: Valida√ß√£o C√©tica S√™nior** - Analisar c√≥digo fonte REAL para confirmar que o comando recebido corresponde ao estado atual do sistema
- **Passo 0.7: NOVO - Consulta Profunda de Fontes Prim√°rias** - Ler ADRs completos, documentos fonte, c√≥digo implementado (PRIMEIRO sempre)
- **Passo 0.8: NOVO - Valida√ß√£o com EXECUTION_MATRIX** - Cross-check com Matrix para detectar discrep√¢ncias ou esquecimentos (ADICIONAL, n√£o substituto)
- **Passo 1: Confirma√ß√£o e Planeamento** - Responder com "PEAF V1.5 Ativado. PAM recebido. Dupla valida√ß√£o executada." e processar o PAM
- **Passo 2: Dry Run T√°tico V3** - Apresentar lista de arquivos-alvo, sum√°rio de mudan√ßas, an√°lise de depend√™ncias validadas em AMBAS camadas
- **Passo 3: Execu√ß√£o Modular e Verificada** - Executar modifica√ß√µes com `get_latest_lsp_diagnostics` cont√≠nuo
- **Passo 4: Relat√≥rio de Execu√ß√£o V3 com Dupla Prova** - 7-CHECK expandido, declara√ß√£o de incerteza e provas de execu√ß√£o com valida√ß√£o dupla

**Protocolos de Conting√™ncia:**
- **Cl√°usula de D√©bito T√©cnico:** Se erros LSP > 20, incluir an√°lise de impacto no Dry Run
- **Circuit Breaker:** Ap√≥s 5 falhas ou 2 horas, declarar falha e escalar
- **PRAPF:** Em falha irrecuper√°vel, gerar Relat√≥rio de Falha de Execu√ß√£o (RFE)

**7-CHECK EXPANDIDO:**
1. Mapear arquivos e fun√ß√µes afetadas
2. Garantir importa√ß√µes e tipos corretos
3. Executar get_latest_lsp_diagnostics
4. Declarar N√≠vel de Confian√ßa (0-100%)
5. Categorizar Riscos (BAIXO/M√âDIO/ALTO/CR√çTICO)
6. Realizar teste funcional completo
7. Documentar decis√µes t√©cnicas para auditoria

**MODO REALISMO C√âTICO (Integrado ao PEAF):**
- Premissa padr√£o: Meu trabalho cont√©m erros at√© prova em contr√°rio
- Nunca esconder problemas ou d√≠vidas t√©cnicas descobertas
- Reportar descobertas imediatamente, mesmo que interrompa implementa√ß√£o
- M√©trica de sucesso: Verdade, n√£o velocidade

Focus: CCB template generation over UI visualization.
Language: Portuguese, studying software architecture.
Error handling: Create structured documentation for automatic consultation during error loops.
**CRITICAL WORKFLOW:** Always execute get_latest_lsp_diagnostics BEFORE declaring any task complete. Never say "pronto" with LSP errors > 0. Follow ESTRATEGIA_ZERO_MICRO_ERROS.md protocol to avoid the 80/20 pattern (80% working, 20% fixing micro errors).

**DATA INTEGRITY PROTECTION:** PAM V1.0 protocol implemented - 5-CHECK validation system for data corruption detection and repair.

**MANDATORY BUG DOCUMENTATION POLICY:** Every bug resolved must be documented in `docs/bugs-solved/[category]/YYYY-MM-DD-descriptive-name.md` with complete technical analysis, root cause, solution implemented, and validation evidence. No exceptions - this creates institutional knowledge and prevents regression.

**CONTEXT ENGINEERING PROTOCOL V2.0:** Dual-layer validation system implemented. The `architecture/EXECUTION_MATRIX.md` serves as an ADDITIONAL security layer for context validation, NOT a replacement for primary sources. Always consult ADRs, documentation, and code FIRST, then cross-check with Matrix to detect discrepancies. This prevents context loss and ensures 100% architectural conformity tracking.

### üö® PROTOCOLO DE DOCUMENTA√á√ÉO ARQUITETURAL MANDAT√ìRIO - FASE DE PLANEJAMENTO üö®

**[DIRETRIZ CR√çTICA - INEGOCI√ÅVEL]**  
**Status:** ESTAMOS NA FASE DE MAPEAMENTO E PLANEJAMENTO ARQUITETURAL  
**Pr√≥xima Fase:** EXECU√á√ÉO (somente ap√≥s completar todo planejamento)  

**[PERSONA E FUN√á√ÉO]**  
Nesta fase, sou um **Arquiteto Documentador**:
- **SOU:** Planejador que desenha a planta arquitetural
- **N√ÉO SOU:** Executor que constr√≥i ou implementa c√≥digo

**[DEFINI√á√ÉO DE ENTREG√ÅVEIS]**  
- **Documenta√ß√£o Arquitetural de Planejamento:** Descreve o que **SER√Å FEITO** (estrat√©gias, planos, ADRs)
- **N√ÉO Relat√≥rios de Execu√ß√£o:** Que descrevem o que **FOI FEITO**

**[PROTOCOLO MANDAT√ìRIO DE TRABALHO]**  
1. **Analisar o PAM:** Processar o Pacote de Ativa√ß√£o de Miss√£o t√°tico
2. **Localizar/Criar Artefato:** Navegar para `/architecture` e criar arquivo apropriado (`-strategy.md`, `-plan.md`, `ADR-XXX.md`)
3. **Produzir Documenta√ß√£o:** Preencher com plano, estrat√©gia, diagramas ou design solicitado
4. **Validar Conclus√£o:** Confirmar que documento de planejamento foi criado conforme protocolos

**[CRIT√âRIO DE SUCESSO]**  
Miss√£o conclu√≠da quando artefato de **documenta√ß√£o de planejamento arquitetural** estiver:
- ‚úÖ Criado e salvo no diret√≥rio correto
- ‚úÖ Em conformidade com requisitos do PAM
- ‚úÖ Documentando o que SER√Å implementado (n√£o executando)

**LEMBRETE CR√çTICO:** N√ÉO executar o plano documentado. Apenas criar o plano para futura execu√ß√£o ap√≥s conclus√£o de TODA fase de planejamento arquitetural.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter
- **Styling**: Tailwind CSS with shadcn/ui components
- **State Management**: TanStack Query for server state, `useReducer` for complex local state
- **Form Handling**: React Hook Form with Zod validation
- **Build Tool**: Vite

### Backend Architecture
- **Framework**: Express.js with TypeScript
- **API Pattern**: RESTful API with modular route organization
- **Database**: PostgreSQL with Drizzle ORM
- **Authentication**: Supabase Auth integration with JWT middleware and custom RBAC
- **File Storage**: Supabase Storage
- **Job Queue Architecture**: BullMQ-based async worker system with Redis, supporting parallel operations and retry mechanisms.
- **Cache Layer L2**: Redis-based caching for commercial tables queries with 1-hour TTL, using cache-aside pattern.
- **Time Management**: Centralized timezone utilities for Bras√≠lia timezone consistency.
- **Modular Architecture**: Monolith progressively decomposed into domain modules (Auth, Users, Propostas, Pagamentos, Integra√ß√µes).
- **Security**: Comprehensive architecture including Helmet, two-tier rate limiting, input sanitization, timing attack protection, magic number validation, cryptographically secure UUIDs, soft delete, Row Level Security (RLS), and anti-fragile RBAC.
- **CI/CD Pipeline**: GitHub Actions with specialized workflows for CI, CD-Staging, and Security, including automated testing, SAST/SCA scanning, deployment readiness checks, and rollback automation.
- **Observability**: Winston structured logging with correlation IDs, Sentry error tracking, health check endpoints, and automated backup scripts.
- **Configuration Management**: Centralized config module with environment-based secrets and validation.
- **Feature Flags System**: Unleash-client integration with automatic fallback mode, React context provider, and pre-configured flags for various features and A/B testing.
- **Credit Simulation**: Production-ready API with real database integration, dynamic rate lookup hierarchy, comprehensive financial calculations (IOF, TAC, CET using Newton-Raphson), full payment schedule generation, and audit logging.
- **Document Management**: Secure private bucket with signed URLs, organized folder structure, multi-format support, and admin client authentication.
- **PDF Generation**: Template-based CCB generation using `pdf-lib` for precise field filling and dynamic data adjustment.
- **Payment Workflow**: Complete payment queue system with batch processing, multiple payment methods, formalization tracking, and dual-storage strategy.
- **Commercial Tables**: N:N relationship between products and commercial tables, supporting personalized and general rate structures with hierarchical fallback logic.
- **Status Management FSM**: Centralized Finite State Machine replacing fragile enum with robust transition validation and audit logging.
- **Test Infrastructure**: Comprehensive test environment with direct postgres connection, complete RLS bypass, automated database cleanup, and full integration test coverage for critical business logic.
- **Schema Migration Strategy**: Production-ready migration system using Drizzle-Kit with Zero Downtime patterns, Expand/Contract methodology, automated rollback capabilities, and comprehensive migration tracking.

### Database Schema
- PostgreSQL with Drizzle ORM.
- Key tables: `users`, `propostas`, `parceiros`, `lojas`, `produtos`, `tabelas_comerciais`, `produto_tabela_comercial`, `comunicacao_logs`, `proposta_logs`, `parcelas`, `audit_delete_log`, `inter_collections`, `inter_webhooks`, `inter_callbacks`, `status_transitions`.
- `propostas` table includes detailed client data, loan conditions, formalization tracking, and an expanded status enum.
- `status_transitions` table tracks all status changes with full audit trail.
- Soft deletes implemented using `deleted_at` columns.
- Sequential numeric IDs for `propostas.id`.
- **Status FSM V2.0 system**: Event-driven status transitions with complete audit trail, centralized validation, and robust error handling.
- **Test Environment Support**: Direct postgres connection capabilities with user and profile associations for comprehensive test data setup bypassing RLS policies.
- **Doutrina de Persist√™ncia de Dados**: Development and staging environments use Supabase, production uses Azure. Other database providers are prohibited.

## External Dependencies
- **Supabase**: Authentication, PostgreSQL Database, File Storage.
- **Drizzle ORM**: Type-safe ORM for PostgreSQL.
- **TanStack Query**: Server state management.
- **React Hook Form**: Form management.
- **Zod**: Schema validation.
- **Tailwind CSS**: Styling.
- **shadcn/ui**: React components.
- **Wouter**: React router.
- **Vite**: Build tool.
- **Express.js**: Backend framework.
- **postgres**: PostgreSQL client.
- **jwt-simple**: JWT token handling.
- **Helmet**: HTTP security headers.
- **express-rate-limit**: API rate limiting.
- **zxcvbn**: Password strength validation.
- **uuid**: Cryptographically secure UUIDs.
- **pdf-lib**: Dynamic PDF generation.
- **ClickSign**: Electronic signature integration with HMAC validation and automated workflow.
- **Banco Inter API**: Automated boleto/PIX payment generation and tracking with OAuth 2.0 authentication (mTLS), and webhook system for payment notifications.